UniOTalign: Protein Sequence Alignment via Optimal Transport
========================================================

## 1. Introduction

UniOTalign is a novel tool for protein sequence alignment that offers a fundamentally different approach from classical dynamic programming methods like Smith-Waterman. Instead of finding an optimal path of local scores, UniOTalign treats protein alignment as a global matching problem using the mathematical framework of Optimal Transport (OT).

The algorithm represents each protein as a distribution of its residues in a high-dimensional space, where each residue is described by a rich feature vector generated by the ESM-2 Protein Language Model. The core of the method is the Fused Unbalanced Gromov-Wasserstein (FUGW) distance, which finds the optimal correspondence (transport plan) between two proteins by simultaneously:

1.  **Minimizing Feature Dissimilarity**: Matching residues that are biochemically and evolutionarily similar.
2.  **Preserving Internal Geometry**: Ensuring the overall 3D fold and sequence continuity are respected.
3.  **Allowing Gaps**: Using the principles of Unbalanced OT to naturally handle insertions and deletions, which is crucial for biological sequences.

This global perspective makes UniOTalign particularly effective for aligning proteins with non-sequential similarities, such as circular permutations, which are challenging for traditional methods.

## 2. Dependencies

Before running, ensure you have the required Python libraries installed:

- `torch`
- `transformers`
- `pot` (Python Optimal Transport Library)
- `scipy`
- `biopython`

You can install them via pip:
```
pip install torch transformers pot scipy biopython
```

## 3. Program Usage

The program is run from the command line using `unialign_v6.py` (or the most current version).

### Parameters:

- `seq_a_path`: (Required) Path to the first protein sequence file.
- `seq_b_path`: (Required) Path to the second protein sequence file.
- `--chain_a`: (Optional) The chain ID to use for the first protein if it is a PDB/CIF file. If omitted, the program automatically selects the first available chain.
- `--chain_b`: (Optional) The chain ID to use for the second protein if it is a PDB/CIF file.
- `--alpha`: (Optional) A float between 0 and 1 that balances feature similarity vs. structural preservation. Default is `0.5`.
- `--reg_m`: (Optional) The marginal relaxation parameter, which acts as a gap penalty. Higher values lead to fewer gaps. Default is `1.0`.
- `--epsilon`: (Optional) The initial entropic regularization value. The program will automatically increase this if the solver encounters stability issues. Default is `0.01`.
- `--model_dir`: (Optional) Path to the directory containing the local ESM-2 model. Default is `./local_esm_model`.

### A Note on Input Formats:

While the program was tested using PDB files to extract residue types and numbers for validation, the core UniOTalign algorithm **only requires the protein sequence**. Therefore, providing input as FASTA files is the simplest and most direct way to use the tool. The program can also parse the sequence from PDB and mmCIF files if needed.

## 4. Command-Line Examples

Here are two examples demonstrating how to run an alignment.

### Example 1: Using FASTA files

This is the recommended and simplest usage, as UniOTalign operates on sequences.

```bash
python unialign_v6.py path/to/protein1.fasta path/to/protein2.fasta
```

### Example 2: Using PDB files

If you have PDB files, the program will extract the sequence for you. You can optionally specify which chain to use.

```bash
# Align chain A of 1c3w.pdb with chain B of 1u5p.pdb
python unialign_v6.py data/1c3w.pdb data/1u5p.pdb --chain_a A --chain_b B
```

If you omit the chain IDs, the program will automatically select the first available chain in each file:

```bash
# Auto-select chains for alignment
python unialign_v6.py data/1c3w.pdb data/1u5p.pdb
```
